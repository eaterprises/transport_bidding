<!DOCTYPE html>
<html lang="en" ng-app="foodApp">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Transport Bidding - Open Food Network</title>

        <link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
        <link type="text/css" rel="stylesheet" href="css/app.css">

        <script type="text/javascript" language="javascript" src="js/lib/jquery-2.0.1.js"></script>
        <script type="text/javascript" language="javascript" src="js/lib/angular.js"></script>
        <script type="text/javascript" language="javascript" src="js/lib/angular-sanitize.js"></script>
        <script type="text/javascript" language="javascript" src="js/lib/ui-bootstrap-tpls-0.3.0.js"></script>
        <script src="http://maps.google.com/maps/api/js?sensor=false"></script>
        <script type="text/javascript" language="javascript" src="js/map.js"></script>

        <script>
            angular.module("foodApp", ['ui.bootstrap', 'ngSanitize'])
                    .controller("InvCtrl", ['$scope', '$http',
                function(scope, http) {
                    initialize();
                    scope.sortReverse = {};
                    scope.filterAddr = "";
                    scope.isReverse = false;
                    //make more generic @todo
                    scope.filterProducts = function(item) {
                        var isMatch = true;

                        if (typeof scope.search_product != "undefined"
                                && scope.search_product != "") {
                            var regex = new RegExp(scope.search_product, "i")
                            isMatch = isMatch && regex.test(item.product_name);
                        }

                        if (typeof scope.search_src != "undefined"
                                && scope.search_src != "") {
                            var regex = new RegExp(scope.search_src, "i")

                            isMatch = isMatch && regex.test(item.supplier.address.suburb);
                        }

                        if (typeof scope.search_dest != "undefined"
                                && scope.search_dest != "") {
                            var regex = new RegExp(scope.search_dest, "i")

                            isMatch = isMatch && regex.test(item.distributor.address.suburb);
                        }

                        return isMatch;
                    }

                    scope.filterAddress = function(item) {
                        if (scope.filterAddr !== "") {
                            return item.supply_address === scope.filterAddr
                                    || item.delivery_address === scope.filterAddr;
                        }

                        return true;
                    }

                    scope.rowDetails = [];
                    scope.productData = {};
                    scope.emailOpen = false;

                    var getLatLon = function(address, callback) {
                        geocoder.geocode({
                            address: address,
                            region: 'no'
                        }, function(results, status) {
                            if (status.toLowerCase() === 'ok') {
                                // Get center
                                var coords = new google.maps.LatLng(
                                        results[0]['geometry']['location'].lat(),
                                        results[0]['geometry']['location'].lng()
                                        );
                                callback(coords);
                            } else {
                                console.log(status);
                            }
                        });
                    };

                    var addressLatLon = [];
                    var polyLines = {};

                    scope.getProductData = function() {
                        http.get("/api/products").success(function(data) {
                            scope.productData = data;

                            var uniqueSupplyAddr = {};
                            var uniqueDeliveryAddr = {};
                            for (var row in data) {
                                uniqueSupplyAddr[data[row].supply_address] = 1;
                                uniqueDeliveryAddr[data[row].delivery_address] = 1;
                            }

                            var counter = 0;

                            for (var addr in uniqueSupplyAddr) {
                                addAddress(addr, counter++, false);
                            }

                            for (var addr in uniqueDeliveryAddr) {
                                addAddress(addr, counter++, true);
                            }

                            setTimeout(function() {
                                for (var row in data) {
                                    if (!(data[row].supply_address in polyLines)) {
                                        polyLines[data[row].supply_address] = {};
                                    }

                                    var line = drawPolyLine(addressLatLon[data[row].supply_address],
                                            addressLatLon[data[row].delivery_address]);
                                    if (line !== false) {
                                        polyLines[data[row].supply_address][data[row].delivery_address] = line;
                                    }
                                }
                            }, counter++ * 650);
                        });
                    };

                    var addMarker = function(latlng, addr, isDest) {
                        var icon = isDest ? 'img/delivery_marker.png' : 'img/supplier_marker.png';
                        var marker = new google.maps.Marker({
                            position: latlng,
                            map: map,
                            icon: icon
                        });

                        google.maps.event.addListener(marker, "click", function() {
                            scope.filterAddr = addr;
                            scope.$apply();
                        });
                    };

                    var addAddress = function(addr, counter, isDest) {
                        setTimeout(function() {
                            getLatLon(addr, function(latLon) {
                                addressLatLon[addr] = latLon;
                                addMarker(latLon, addr, isDest);
                            });
                        }, counter * 650);
                    };

                    scope.setSortCol = function(index) {
                        if (typeof scope.sortReverse[index] === 'undefined')
                            scope.sortReverse[index] = false;
                        else
                            scope.sortReverse[index] = !scope.sortReverse[index];
                        scope.sortCol = index;
                    };

                    var selectedPolyLine;

                    scope.onRowClick = function(row) {
                        showRowDetails(row);
                        var path = [addressLatLon[row.supply_address],
                            addressLatLon[row.delivery_address]];

                        if (angular.isUndefined(selectedPolyLine)) {
                            selectedPolyLine = new google.maps.Polyline({
                                map: map,
                                strokeColor: '#49599C',
                                strokeOpacity: '0.75',
                                strokeWeight: '6',
                                path: path
                            });
                        } else {
                            selectedPolyLine.setPath(path);
                            selectedPolyLine.setVisible(true);
                        }
                    };

                    var showRowDetails = function(row) {
                        scope.rowDetails = [{
                                desc: "Shipping Instruction",
                                val: row.shipping_instructions
                            }, {
                                desc: "Destination Address",
                                val: row.delivery_address
                            }, {
                                desc: "Source Address",
                                val: row.supply_address
                            }, {
                                desc: "Quantity",
                                val: row.quantity
                            }, {
                                desc: "Weight",
                                val: row.variant_weight
                            }, {
                                desc: "Variant",
                                val: row.variant
                            }, {
                                desc: "Product Name",
                                val: row.product_name
                            }];
                    };

                    scope.getBids = function() {
                        var retval = scope.csvData.data.filter(function(e) {
                            return e.hasBid;
                        });
                        return retval;
                    }

                    var drawPolyLine = function(srcLatLon, destLatLon) {
                        if (!angular.isUndefined(srcLatLon) &&
                                !angular.isUndefined(destLatLon)) {
                            return new google.maps.Polyline({
                                map: map,
                                strokeColor: 'yellow',
                                strokeOpacity: '0.75',
                                strokeWeight: '6',
                                path: [srcLatLon, destLatLon],
                                visible: false
                            });
                        }

                        return false;
                    };

                    var getPolyLine = function(srcAddr, dstAddr) {
                        return polyLines[srcAddr][dstAddr];
                    }

                    scope.updateBidValue = function(row) {
                        if (row.hasBid) {
                            row.bidValue = row.reserve;
                        } else
                            row.bidValue = "";

                        getPolyLine(row.supply_address, row.delivery_address).setVisible(row.hasBid);
                    };

                    scope.resetFilters = function() {
                        scope.filterAddr = "";
                        selectedPolyLine.setVisible(false);
                    }
                    
                    scope.clearBids = function() {
                        scope.productData.forEach(function(e) {
                            if (e.hasBid) {
                                getPolyLine(e.supply_address, e.delivery_address).setVisible(false);
                                e.hasBid = false;
                            }
                        });
                    }

                    scope.sendEmail = function() {
                        var postData = {};
                        postData.customer = {name: scope.customerName,
                            email: scope.customerEmail};
                        postData.headers = scope.csvData.header;
                        postData.data = scope.getBids();
                        postData.numCols = scope.numCols;

                        http.post('/api/sendemail', postData).success(function(data) {
                            scope.emailOpen = true;
                            scope.emailData = data;
                        });
                    };

                    scope.closeEmail = function() {
                        scope.emailOpen = false;
                    }

                    scope.emailDialogOpts = {backdropFade: true, dialogFade: true};

                    scope.isSortReverse = function(index) {
                        return scope.sortReverse[index];
                    };
                }]);
        </script>
    </head>
    <body ng-controller="InvCtrl">

        <div modal="emailOpen" close="closeEmail()" options="emailDialogOpts">
            <div class="modal-header">
                <h4>Customer Email</h4>
            </div>
            <div class="modal-body" ng-bind-html-unsafe="emailData">
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning cancel" ng-click="closeEmail()">Close</button>
            </div>
        </div>

        <!-- <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <a class="brand" href="#">Transport Bidding <small>&dash; Open Food Network</small></a>
                <ul class="nav pull-right">
                    <li><a href="#">My Account</a></li>
                    <li><a href="#">Sign Up</a></li>
                </ul>
            </div>
        </div> 
        -->

        <div class="hero-unit" ng-hide="hideHero">
            <h2>Make an offer to <em>move</em> food.</h2>
            <ol>
                <li>Check the box beside the jobs you want to do.</li>
                <li>Enter the price for each job.</li>
                <li>Provide your name and email address and click 'bid' to confirm your offer.</li>
            </ol>
            <button type="button" class="btn btn-success" ng-click="hideHero = true">Ok, Got it!</button>
        </div>

        <div class="flex-video full-map" id="googleMap"></div>

        <div class="container">
            <div class="row-fluid">
                <div class="span9">
                    <table ng-init="getProductData()" class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>
                                    <input type="text" ng-model="search_product" class="input-medium" /><br/>
                                    <a ng-click="setSortCol('product_name')">Product
                                        <i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse('product_name')]"></i></a>
                                </th>
                                <th>
                                    <a ng-click="setSortCol('quantity')">Qty
                                        <i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse('quantity')]"></i></a>
                                </th>
                                <th>
                                    <input type="text" ng-model="search_src" class="input-medium"/><br/>
                                    <a ng-click="setSortCol('supplier.address.suburb')">Source
                                        <i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse('supplier.address.suburb')]"></i></a>
                                </th>
                                <th>
                                    <input type="text" ng-model="search_dest" class="input-medium" /><br/>
                                    <a ng-click="setSortCol('distributor.address.suburb')">Destination
                                        <i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse('distributor.address.suburb')]"></i></a>
                                </th>
                                <th>
                                    <a ng-click="setSortCol('reserve')">Reserve
                                        <i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse('reserve')]"></i></a>
                                </th>
                                <th><button ng-click="clearBids()" class="btn btn-small">Clear</button><br>Bid</th>
                                <th>Bid Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-click="onRowClick(row)"
                                ng-repeat="row in productData | filter:filterProducts | filter:filterAddress | orderBy:sortCol:sortReverse[sortCol]">
                                <td>{{row.product_name}}</td>
                                <td>{{row.quantity}}</td>
                                <td>{{row.supplier.address.suburb}}</td>
                                <td>{{row.distributor.address.suburb}}</td>
                                <td>{{row.reserve}}</td>
                                <td><input type="checkbox" ng-model="row.hasBid" ng-change="updateBidValue(row)"></td>
                                <td><input type="text" class="input-mini" ng-model="row.bidValue"></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="span3 well">
                    <form name="submitForm" ng-submit="sendEmail()">
                        <b class="muted">Name: </b><input required type="text" ng-model="customerName" hint="e.g. Jane Doe" /><br/>
                        <b class="muted">Email: </b><input required type="email" ng-model="customerEmail" hint="jane@email.com" /><br/>
                        <input type="submit" class="btn btn-success" value="Bid"/>
                        <button class="btn" ng-click="resetFilters()">Reset Filters</button>
                    </form>
                    <h4>Details:</h4>
                    <p ng-repeat="detail in rowDetails">
                        <b class="muted">{{detail.desc}}:</b><br />{{detail.val}}</p>
                </div>
            </div>
        </div>
    </body>
</html>
