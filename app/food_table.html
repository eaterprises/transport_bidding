<!DOCTYPE html>
<html lang="en" ng-app="foodApp">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transport Bidding - Open Food Network</title>

	<link type="text/css" rel="stylesheet" href="css/bootstrap.min.css">
	<link type="text/css" rel="stylesheet" href="css/datepicker.css">
	<link type="text/css" rel="stylesheet" href="css/app.css">

	<script type="text/javascript" language="javascript" src="js/jquery-2.0.1.js"></script>
	<script type="text/javascript" language="javascript" src="js/angular.js"></script>
	<script type="text/javascript" language="javascript" src="js/angular-sanitize.js"></script>
	<script type="text/javascript" language="javascript" src="js/ui-bootstrap-tpls-0.3.0.js"></script>
	<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
	<script type="text/javascript" language="javascript" src="js/map.js"></script>

	<script>
		angular.module("foodApp", ['ui.bootstrap', 'ngSanitize'])
		.controller("InvCtrl", ['$scope', '$http',
		function (scope, http) {
			initialize();
			scope.sortReverse = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
			scope.isReverse = false;
			
			scope.rowDetails = [];
			scope.csvData = {};
			scope.emailOpen = false;

			scope.getCsvData = function (date) {
				http.get("/getcsv").success(function (data) {
				scope.csvData = data;
				var uniqueSupplyAddr = {};
				var uniqueDeliveryAddr = {};
				var i = 0;
				for(var row in data.data) {
					i++;
					uniqueSupplyAddr[data.data[row].col2] = 1;
					uniqueDeliveryAddr[data.data[row].col12] = 1;
				}
				var i = 0;
				var counter = 0;
				for (var row in uniqueSupplyAddr) {
					counter++;
					i++;
					(function(row) {
						setTimeout(function() {
						addSourceMarkerToAddress(row);
					}, counter * 600)})(row);
				};
				var i = 0;
				for (var row in uniqueDeliveryAddr) {
					counter++;
					i++;
					(function(row) {
						setTimeout(function() {
						addDestMarkerToAddress(row);
					}, counter * 600)})(row);
				};

				scope.numCols = data.numCols;
				});
			};

			scope.setSortCol = function(index) {
				scope.sortReverse[index] = !scope.sortReverse[index];
				scope.sortCol = "col" + index;
				scope.isReverse = scope.sortReverse[index];
			};
			
			scope.showRowDetails = function(row) {
				scope.rowDetails = [];
				for (var i = 0; i < scope.numCols; i++) {
					if (row["col" + i] !== 'undefined') {
						scope.rowDetails.push({
						value : row["col" + i],
						header : scope.csvData.header["col" + i]
						});
					}
				}
			};

			scope.getBids = function() {
				var retval = scope.csvData.data.filter(function(e) {
				return e.hasBid;
				});
				return retval;
			}

			scope.updateBidValue = function(row) {
				if(row.hasBid)
					row.bidValue = row.col10;
				else
					row.bidValue = "";

				(function(row) {
					setTimeout(function() {
					setSourceDestAddress(row.col2, row.col12);
				}, 600)})(row);
			}

			scope.sendEmail = function() {
				var postData = { };
				postData.customer = { 	name: scope.customerName, 
										email: scope.customerEmail };
				postData.headers = scope.csvData.header;
				postData.data = scope.getBids();
				postData.numCols = scope.numCols;

				http.post('/sendemail', postData).success(function(data) {
					scope.emailOpen = true;
					console.log(data);
					scope.emailData = data;
				});
			};

			scope.closeEmail = function() {
				scope.emailOpen = false;
			}

			scope.emailDialogOpts = {backdropFade: true, dialogFade: true};

			scope.getSupplierAddresses = function() {
				var bidRows = scope.getBids();
				console.log(bidRows); 
			}
			
			scope.isSortReverse = function(index) {
				return scope.sortReverse[index]?true:false;
			};
		}]);
	</script>
</head>
<body ng-controller="InvCtrl">

	<div modal="emailOpen" close="closeEmail()" options="emailDialogOpts">
		<div class="modal-header">
			<h4>Customer Email</h4>
		</div>
		<div class="modal-body" ng-bind-html-unsafe="emailData">
		</div>
		<div class="modal-footer">
			<button class="btn btn-warning cancel" ng-click="closeEmail()">Close</button>
		</div>
	</div>

	<div class="navbar navbar-static-top">
		<div class="navbar-inner">
			<a class="brand" href="#">Transport Bidding <small>&dash; Open Food Network</small></a>
			<ul class="nav pull-right">
				<li><a href="#">My Account</a></li>
				<li><a href="#">Sign Up</a></li>
			</ul>
		</div>
	</div>

	<div class="hero-unit">
		<h2>Make an offer to <em>move</em> food.</h2>
		<ol>
			<li>Check the box beside the jobs you want to do.</li>
			<li>Enter the price for each job.</li>
			<li>Provide your name and email address and click 'bid' to confirm your offer.</li>
		</ol>
	</div>

	<div class="flex-video full-map" id="googleMap"></div>

	<div class="container">
	<div class="row-fluid">
		<div class="span9">
		<table ng-init="getCsvData()" class="table table-striped table-hover">
			<thead>
			<tr>
				<th>
				<input type="text" ng-model="search.col6" class="input-medium" placeholder="Sort"><br/>
				<a ng-click="setSortCol(6)">{{csvData.header.col6}}
					<i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse(6)]"></i></a>
				</th>
				<th>
				<a ng-click="setSortCol(9)">{{csvData.header.col9}}
					<i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse(9)]"></i></a>
				</th>
				<th>
				<input type="text" ng-model="search.col4" class="input-medium" placeholder="Sort"><br/>
				<a ng-click="setSortCol(4)">{{csvData.header.col4}}
					<i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse(4)]"></i></a>
				</th>
				<th>
				<input type="text" ng-model="search.col14" class="input-medium" placeholder="Sort"><br/>
				<a ng-click="setSortCol(14)">{{csvData.header.col14}}
					<i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse(14)]"></i></a>
				</th>
				<th>
				<a ng-click="setSortCol(10)">{{csvData.header.col10}}
					<i ng-class="{true:'icon-chevron-up', false:'icon-chevron-down'}[isSortReverse(10)]"></i></a>
				</th>
				<th>Can Do</th>
				<th>Bid</th>
			</tr>
			</thead>
			<tbody>
				<tr ng-click="showRowDetails(row)"
				 ng-repeat="row in csvData.data | filter:search | orderBy:sortCol:isReverse" class="id-{{row._id}}">
					<td class="title">{{row.col6}}</td>
					<td>{{row.col9}}</td>
					<td>{{row.col4}}</td>
					<td>{{row.col14}}</td>
					<td>{{row.col10}}</td>
					<td><input type="checkbox" ng-model="row.hasBid" ng-change="updateBidValue(row)"></td>
					<td><input type="text" class="input-mini" ng-model="row.bidValue"></td>
			</tr>
			</tbody>
			</table>
		</div>
		<div class="span3">
			<div class="well">
			<h4>Details:</h4>
			<p ng-repeat="detail in rowDetails">
			<b class="muted">{{detail.header}}:</b><br />{{detail.value}}</p>

			<form name="submitForm" ng-submit="sendEmail()">
				<input required type="text" ng-model="customerName" hint="e.g. Jane Doe" placeholder="Full Name" /><br/>
				<input required type="email" ng-model="customerEmail" hint="jane@email.com" placeholder="Email Address" /><br/>
				<input type="submit" class="btn btn-success" value="Bid"/>
			</form>
			</div>
		</div>
	</div>
	</div>

	<div class="row-fluid">
		<div class="span12" style="text-align: center; margin: 0 auto"><img src="img/footer.png"></img></div>
	</div>
</body>
</html>
